<script>
  const rowsEl = document.getElementById("rows");
  const qEl = document.getElementById("q");
  let allergenData = [];

  const iconMap = {
    gluten: "gluten.svg",
    milk: "milk.svg",
    eggs: "eggs.svg",
    fish: "fish.svg",
    crustacean: "crustacean.svg",
    mollusc: "mollusc.svg",
    nuts: "nuts.svg",
    peanut: "peanut.svg",
    sesame: "sesame.svg",
    soya: "soya.svg",
    lupin: "lupin.svg",
    sulphur: "sulphur.svg",
    mustard: "mustard.svg",
    celery: "celery.svg"
  };

  function iconPill(label, cls){
    const key = (label || "").toLowerCase();
    const src = iconMap[key];

    const span = document.createElement("span");
    span.className = `pill ${cls}`;

    if (src){
      const img = document.createElement("img");
      img.src = src;
      img.alt = label;
      img.style.height = "16px";
      img.style.width = "16px";
      img.style.verticalAlign = "middle";
      img.style.marginRight = "6px";
      span.appendChild(img);
    }

    span.appendChild(document.createTextNode(label));
    return span;
  }

  function render(list){
    rowsEl.innerHTML = "";

    list.forEach(item => {
      const tr = document.createElement("tr");

      const tdDish = document.createElement("td");
      tdDish.textContent = item.dish || "—";

      const tdContains = document.createElement("td");
      (item.contains?.length ? item.contains : ["—"]).forEach(a => {
        tdContains.appendChild(a === "—" ? document.createTextNode("—") : iconPill(a,"contains"));
      });

      const tdMay = document.createElement("td");
      (item.may?.length ? item.may : ["—"]).forEach(a => {
        tdMay.appendChild(a === "—" ? document.createTextNode("—") : iconPill(a,"may"));
      });

      tr.appendChild(tdDish);
      tr.appendChild(tdContains);
      tr.appendChild(tdMay);
      rowsEl.appendChild(tr);
    });
  }

  function filter(){
    const term = qEl.value.trim().toLowerCase();

    if(!term){
      rowsEl.innerHTML = "";
      return;
    }

    render(allergenData.filter(d =>
      (d.dish || "").toLowerCase().includes(term)
    ));
  }

  function parseCsvLine(line){
    const out = [];
    let cur = "";
    let inQuotes = false;

    for (let i = 0; i < line.length; i++){
      const ch = line[i];
      if (ch === '"'){
        if (inQuotes && line[i+1] === '"'){ cur += '"'; i++; }
        else inQuotes = !inQuotes;
      } else if (ch === "," && !inQuotes){
        out.push(cur);
        cur = "";
      } else {
        cur += ch;
      }
    }
    out.push(cur);
    return out.map(s => s.trim());
  }

  async function loadData(){
    const res = await fetch("allergens.csv", { cache: "no-store" });
    const text = await res.text();

    const lines = text.replace(/\r/g,"").trim().split("\n");
    const dataLines = lines.slice(1).filter(Boolean);

    allergenData = dataLines.map(line => {
      const [dish, contains, may] = parseCsvLine(line);

      const containsList = (contains || "")
        .replace(/^"|"$/g,"")
        .split(",")
        .map(x => x.trim())
        .filter(Boolean);

      const mayList = (may || "")
        .replace(/^"|"$/g,"")
        .split(",")
        .map(x => x.trim())
        .filter(Boolean);

      return {
        dish: (dish || "").replace(/^"|"$/g,""),
        contains: containsList,
        may: mayList
      };
    }).filter(x => x.dish);
  }

  qEl.addEventListener("input", filter);

  loadData();

  document.getElementById("updated").textContent =
    new Date().toLocaleDateString(undefined, {
      year:"numeric",
      month:"short",
      day:"numeric"
    });
</script>
